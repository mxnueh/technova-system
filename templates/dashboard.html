<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floppy Dashboard</title>
    <link rel="icon" href="{{ url_for('static', filename='../static/img/tech_2.jpg') }}" type="image/jpg">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="../static/css/dashboard.css" type="text/css">
</head>
<body style="background-color: #000; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
    <!-- Sidebar Navegation -->
    <nav>
        <!-- Perfil de Usuario Compacto -->
        <div class="sidebar-profile">
            <div class="profile-image">
                <!-- Si hay una imagen de usuario disponible -->
                <!-- <img src="{{ url_for('static', filename='img/user-avatar.jpg') }}" alt="Foto de perfil"> -->
                <!-- Si no hay imagen, mostrar un icono -->
                <i class="fas fa-user"></i>
            </div>
            <div class="profile-info">
                <div class="profile-name">Usuario Demo</div>
                <div class="profile-title">Monitor de Nivel de Agua</div>
            </div>
        </div>
        
        <!-- Menú Principal -->
        <ul>
            <li><a href="/dashboard" style="background: rgba(255, 255, 255, 0.1); color: white; border-left: 3px solid rgba(34, 197, 94, 0.8);"><i class="fas fa-home"></i> <span>Inicio</span></a></li>
        </ul>
        
        <!-- Categoría: Monitoreo -->
        <div class="nav-category">Monitoreo</div>
        <ul>
            <li><a href="/water-level"><i class="fas fa-water"></i> <span>Nivel del Agua</span></a></li>
        </ul>

        <!-- Separando de la ul de arriba -->
        <ul>
            <li><a href="/history"><i class="fas fa-history"></i> <span>Historial</span></a></li>
        </ul>
        
        <!-- Categoría: Cuenta -->
        <div class="nav-category">Cuenta</div>
        <ul>
            <li><a href="/config"><i class="fas fa-cog"></i> <span>Configuración</span></a></li>
        </ul>

        <!-- Separando de la ul de arriba -->
        <ul>
            <li><a href="/logout"><i class="fas fa-sign-out-alt"></i> <span>Cerrar Sesión</span></a></li>
        </ul>
    </nav>

    <!-- Hero Section como página principal -->
    <div style="margin-left: 250px; min-height: 100vh; padding: 60px 40px; text-align: center; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center;">
        <div style="position: relative; z-index: 1; max-width: 1400px; width: 100%;">
            <h1 style="font-size: 2.5rem; margin-bottom: 30px; color: white; text-shadow: 0 4px 8px rgba(0,0,0,0.7); font-weight: 700;">Sistema de Monitoreo Floppy</h1>
            <p style="font-size: 1.2rem; max-width: 900px; margin: 0 auto 50px; color: rgba(255,255,255,0.95); line-height: 1.6;">Tecnología avanzada para el monitoreo de niveles de agua en tiempo real</p>
            
            <!-- Estado del Sistema -->
            <div style="display: inline-block; background: rgba(255,255,255,0.2); backdrop-filter: blur(15px); padding: 25px 50px; border-radius: 60px; margin-bottom: 60px; border: 2px solid rgba(255,255,255,0.3);">
                <span style="color: white; font-weight: bold; font-size: 1rem;">Estado del Sistema:</span>
                <span id="systemStatus" style="background: #2ecc71; color: white; padding: 8px 20px; border-radius: 25px; font-weight: bold; font-size: 1rem; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);">Activo</span>
            </div>
            
            <!-- Tarjetas de acceso rápido -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 40px; max-width: 1400px; margin: 0 auto;">
                <!-- Nivel Actual -->
                <div style="background: rgba(255,255,255,0.15); border-radius: 20px; padding: 40px; box-shadow: 0 8px 25px rgba(0,0,0,0.3); transition: all 0.4s ease; cursor: pointer; border: 1px solid rgba(255,255,255,0.2);">
                    <div style="display: flex; align-items: center; margin-bottom: 25px;">
                        <div style="width: 70px; height: 70px; border-radius: 20px; background: linear-gradient(45deg, #3498db, #2980b9); display: flex; align-items: center; justify-content: center; margin-right: 25px; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);">
                            <i class="fas fa-tachometer-alt" style="font-size: 32px; color: white;"></i>
                        </div>
                        <h3 style="margin: 0; color: white; font-size: 1.2rem; font-weight: 600;">Nivel Actual</h3>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <p style="margin: 0; color: rgba(255,255,255,0.8); font-size: 0.9rem;">Nivel de Agua</p>
                            <p style="margin: 10px 0 0; font-size: 1.8rem; font-weight: bold; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3);" id="dashCurrentLevel">-- m</p>
                        </div>
                        <div style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid #3498db; display: flex; align-items: center; justify-content: center; background: rgba(52, 152, 219, 0.1);">
                            <span style="color: white; font-weight: bold; font-size: 1.2rem;" id="dashStatusIcon"><i class="fas fa-check"></i></span>
                        </div>
                    </div>
                </div>
                
                <!-- Monitoreo Detallado -->
                <div style="background: rgba(255,255,255,0.15); border-radius: 20px; padding: 40px; box-shadow: 0 8px 25px rgba(0,0,0,0.3); transition: all 0.4s ease; cursor: pointer; border: 1px solid rgba(255,255,255,0.2);">
                    <div style="display: flex; align-items: center; margin-bottom: 25px;">
                        <div style="width: 70px; height: 70px; border-radius: 20px; background: linear-gradient(45deg, #2ecc71, #27ae60); display: flex; align-items: center; justify-content: center; margin-right: 25px; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);">
                            <i class="fas fa-water" style="font-size: 32px; color: white;"></i>
                        </div>
                        <h3 style="margin: 0; color: white; font-size: 1.2rem; font-weight: 600;">Monitoreo</h3>
                    </div>
                    <p style="color: rgba(255,255,255,0.9); margin-bottom: 25px; font-size: 0.9rem; line-height: 1.5;">Acceso al monitoreo de niveles de agua en tiempo real</p>
                    <a href="/water-level" style="display: inline-block; padding: 10px 20px; background: linear-gradient(45deg, #2ecc71, #27ae60); color: white; text-decoration: none; border-radius: 35px; font-weight: bold; transition: all 0.3s; font-size: 0.9rem; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);" >
                        <i class="fas fa-chart-line"></i> Ver Detalles
                    </a>
                </div>
                
                <!-- Historial -->
                <div style="background: rgba(255,255,255,0.15); border-radius: 20px; padding: 40px; box-shadow: 0 8px 25px rgba(0,0,0,0.3); transition: all 0.4s ease; cursor: pointer; border: 1px solid rgba(255,255,255,0.2);">
                    <div style="display: flex; align-items: center; margin-bottom: 25px;">
                        <div style="width: 70px; height: 70px; border-radius: 20px; background: linear-gradient(45deg, #9b59b6, #8e44ad); display: flex; align-items: center; justify-content: center; margin-right: 25px; box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4);">
                            <i class="fas fa-history" style="font-size: 32px; color: white;"></i>
                        </div>
                        <h3 style="margin: 0; color: white; font-size: 1.2rem; font-weight: 600;">Historial</h3>
                    </div>
                    <p style="color: rgba(255,255,255,0.9); margin-bottom: 25px; font-size: 0.9rem; line-height: 1.5;">Consulta el registro histórico de mediciones y eventos</p>
                    <a href="/history" style="display: inline-block; padding: 10px 20px; background: linear-gradient(45deg, #9b59b6, #8e44ad); color: white; text-decoration: none; border-radius: 35px; font-weight: bold; transition: all 0.3s; font-size: 0.9rem; box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4);">
                        <i class="fas fa-database"></i> Ver Historial
                    </a>
                </div>
            </div>
            
            <!-- Información del Sistema -->
            <div style="background: rgba(255,255,255,0.15); border-radius: 20px; padding: 35px; box-shadow: 0 8px 25px rgba(0,0,0,0.3); margin-top: 60px; text-align: left; border: 1px solid rgba(255,255,255,0.2);">
                <h3 style="margin-top: 0; color: white; font-size: 1.2rem; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 20px; font-weight: 600;">
                    <i class="fas fa-info-circle" style="margin-right: 15px; color: #3498db;"></i> Información del Sistema
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; margin-top: 25px;">
                    <div>
                        <p style="color: rgba(255,255,255,0.7); margin: 0 0 8px; font-size: 0.9rem;">Canal</p>
                        <p style="color: white; font-weight: bold; margin: 0; font-size: 1rem;" id="dashChannelName">Sensor de Nivel de Agua</p>
                    </div>
                    <div>
                        <p style="color: rgba(255,255,255,0.7); margin: 0 0 8px; font-size: 0.9rem;">ID del Canal</p>
                        <p style="color: white; font-weight: bold; margin: 0; font-size: 1rem;" id="dashChannelId">3000780</p>
                    </div>
                    <div>
                        <p style="color: rgba(255,255,255,0.7); margin: 0 0 8px; font-size: 0.9rem;">Última Actualización</p>
                        <p style="color: white; font-weight: bold; margin: 0; font-size: 1rem;" id="dashLastUpdate">Cargando...</p>
                    </div>
                    <div>
                        <p style="color: rgba(255,255,255,0.7); margin: 0 0 8px; font-size: 0.9rem;">Estado de Conexión</p>
                        <p id="connectionStatus" style="color: #2ecc71; font-weight: bold; margin: 0; font-size: 1rem;">
                            <i class="fas fa-circle" style="font-size: 10px; margin-right: 8px;"></i> Conectado
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh Button 
    <button class="refresh-btn" onclick="refreshData()" title="Actualizar datos" style="position: fixed; bottom: 110px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(45deg, #3498db, #2980b9); border: none; color: white; font-size: 20px; cursor: pointer; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4); transition: all 0.3s; z-index: 1000;" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 6px 20px rgba(52, 152, 219, 0.6)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 15px rgba(52, 152, 219, 0.4)'">
        <i class="fas fa-sync-alt"></i>
    </button> -->

    <script>
        let thingSpeakData = [];
        let channelId = '3000780';
        let fieldNumber = 2;

        // Water level thresholds (adjust these according to your needs)
        const THRESHOLDS = {
            CRITICAL_LOW: 2.0,
            WARNING_LOW: 4.0,
            NORMAL_MIN: 6.0,
            NORMAL_MAX: 12.0,
            WARNING_HIGH: 13.5,
            CRITICAL_HIGH: 15.0
        };

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadThingSpeakData();
            
            // Auto-refresh every 5 minutes
            setInterval(loadThingSpeakData, 5 * 60 * 1000);
        });

        async function loadThingSpeakData() {
            try {
                const resultsCount = 50; // Obtener los últimos 50 resultados
                const url = `/api/thingspeak-data?results=${resultsCount}`;
                
                console.log('Fetching data from proxy endpoint:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    timeout: 10000
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('ThingSpeak response from proxy:', data);
                
                // Validar estructura de datos
                if (!data || typeof data !== 'object') {
                    throw new Error('Respuesta inválida de ThingSpeak');
                }
                
                if (!data.feeds || !Array.isArray(data.feeds)) {
                    throw new Error('No se encontró el array de feeds en la respuesta');
                }
                
                if (data.feeds.length === 0) {
                    throw new Error('No se encontraron datos en el canal');
                }
                
                // Validar que al menos algunos feeds tengan datos válidos
                const validFeeds = data.feeds.filter(feed => 
                    feed && feed.field2 !== null && feed.field2 !== undefined && feed.field2 !== ''
                );
                
                if (validFeeds.length === 0) {
                    throw new Error('No se encontraron datos válidos en field2');
                }
                
                console.log(`Datos válidos encontrados: ${validFeeds.length} de ${data.feeds.length}`);
                
                processThingSpeakData(data);
                updateDashboard();
                
            } catch (error) {
                console.error('Error loading ThingSpeak data:', error);
                
                let errorMessage = 'Error desconocido';
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'Error de conexión. Verifique su conexión a internet.';
                } else if (error.message.includes('HTTP 404')) {
                    errorMessage = 'Endpoint no encontrado. Verifique la configuración del servidor.';
                } else if (error.message.includes('HTTP 403')) {
                    errorMessage = 'Acceso denegado. Verifique su sesión.';
                } else if (error.message.includes('timeout')) {
                    errorMessage = 'Tiempo de espera agotado. Intente nuevamente.';
                } else {
                    errorMessage = error.message;
                }
                
                console.error('Error al cargar datos:', errorMessage);
                
                // Load sample data as fallback
                console.log('Cargando datos de muestra como respaldo...');
                loadSampleData();
            }
        }

        function processThingSpeakData(data) {
            thingSpeakData = data.feeds
                .filter(feed => feed.field2 !== null && feed.field2 !== undefined)
                .map(feed => ({
                    timestamp: new Date(feed.created_at),
                    level: parseFloat(feed.field2),
                    entry_id: feed.entry_id
                }));

            // Update channel info
            if (data.channel) {
                if (document.getElementById('dashChannelName')) {
                    document.getElementById('dashChannelName').textContent = data.channel.name || 'Sensor de Nivel de Agua';
                }
                if (document.getElementById('dashChannelId')) {
                    document.getElementById('dashChannelId').textContent = data.channel.id || channelId;
                }
                if (document.getElementById('dashLastUpdate')) {
                    document.getElementById('dashLastUpdate').textContent = new Date().toLocaleString('es-ES');
                }
            }
        }

        function loadSampleData() {
            // Fallback sample data when ThingSpeak is not available
            const now = new Date();
            thingSpeakData = [];

            for (let i = 0; i < 50; i++) {
                const timestamp = new Date(now.getTime() - (i * 30 * 60 * 1000)); // Every 30 minutes
                const level = 2 + Math.sin(i * 0.1) * 0.8 + Math.random() * 0.3;

                thingSpeakData.unshift({
                    timestamp: timestamp,
                    level: Math.round(level * 100) / 100,
                    entry_id: i + 1
                });
            }
            updateDashboard();
        }

        function updateDashboard() {
            if (thingSpeakData.length === 0) return;
        
            // Actualizar los elementos del dashboard
            const latest = thingSpeakData[thingSpeakData.length - 1];
            const currentLevel = latest.level;
            
            // Verificar si el sistema está inactivo (todos los valores son 0)
            const isInactive = checkIfSystemInactive(thingSpeakData);
            
            // Actualizar nivel actual en el dashboard
            if (document.getElementById('dashCurrentLevel')) {
                document.getElementById('dashCurrentLevel').textContent = `${currentLevel.toFixed(2)} m`;
            }
            
            // Actualizar información del canal en el dashboard
            if (document.getElementById('dashChannelName')) {
                document.getElementById('dashChannelName').textContent = document.getElementById('channelName') ? 
                    document.getElementById('channelName').textContent : 'Sensor de Nivel de Agua';
            }
            if (document.getElementById('dashChannelId')) {
                document.getElementById('dashChannelId').textContent = document.getElementById('channelId') ? 
                    document.getElementById('channelId').textContent : channelId;
            }
            if (document.getElementById('dashLastUpdate')) {
                document.getElementById('dashLastUpdate').textContent = document.getElementById('lastUpdate') ? 
                    document.getElementById('lastUpdate').textContent : new Date().toLocaleString('es-ES');
            }
            
            // Actualizar estado del sistema
            if (document.getElementById('systemStatus')) {
                if (isInactive) {
                    document.getElementById('systemStatus').textContent = 'Inactivo';
                    document.getElementById('systemStatus').style.background = '#e74c3c';
                    document.getElementById('systemStatus').style.boxShadow = '0 4px 15px rgba(231, 76, 60, 0.4)';
                } else {
                    document.getElementById('systemStatus').textContent = 'Activo';
                    document.getElementById('systemStatus').style.background = '#2ecc71';
                    document.getElementById('systemStatus').style.boxShadow = '0 4px 15px rgba(46, 204, 113, 0.4)';
                }
            }
            
            // Actualizar estado de conexión
            if (document.getElementById('connectionStatus')) {
                if (isInactive) {
                    document.getElementById('connectionStatus').innerHTML = 
                        '<i class="fas fa-circle" style="font-size: 10px; margin-right: 8px;"></i> Desconectado';
                    document.getElementById('connectionStatus').style.color = '#e74c3c';
                } else {
                    document.getElementById('connectionStatus').innerHTML = 
                        '<i class="fas fa-circle" style="font-size: 10px; margin-right: 8px;"></i> Conectado';
                    document.getElementById('connectionStatus').style.color = '#2ecc71';
                }
            }
            
            // Actualizar icono de estado según el nivel de agua
            if (document.getElementById('dashStatusIcon')) {
                let icon = '<i class="fas fa-check"></i>';
                let color = '#2ecc71';
                
                if (isInactive) {
                    icon = '<i class="fas fa-power-off"></i>';
                    color = '#e74c3c';
                } else {
                    const status = getWaterLevelStatus(currentLevel);
                    if (status.class === 'warning') {
                        icon = '<i class="fas fa-exclamation"></i>';
                        color = '#f39c12';
                    } else if (status.class === 'critical') {
                        icon = '<i class="fas fa-exclamation-triangle"></i>';
                        color = '#e74c3c';
                    }
                }
                
                document.getElementById('dashStatusIcon').innerHTML = icon;
                document.getElementById('dashStatusIcon').parentElement.style.borderColor = color;
            }
            
            updateTimestamp();
        }
        
        function checkIfSystemInactive(data) {
            // Check if all recent readings are 0
            const recentData = data.slice(-10); // Check last 10 readings
            return recentData.every(item => item.level === 0);
        }

        function getWaterLevelStatus(level) {
            if (level <= THRESHOLDS.CRITICAL_LOW) {
                return { text: 'Crítico Bajo', class: 'critical' };
            } else if (level <= THRESHOLDS.WARNING_LOW) {
                return { text: 'Bajo', class: 'warning' };
            } else if (level >= THRESHOLDS.CRITICAL_HIGH) {
                return { text: 'Crítico Alto', class: 'critical' };
            } else if (level >= THRESHOLDS.WARNING_HIGH) {
                return { text: 'Alto', class: 'warning' };
            } else {
                return { text: 'Normal', class: 'normal' };
            }
        }

        function showLoading(show) {
            const loading = document.getElementById('loadingIndicator');
            if (show) {
                loading.classList.add('active');
            } else {
                loading.classList.remove('active');
            }
        }

        function showAlert(type, message) {
            const alert = document.getElementById('connectionAlert');
            const alertMessage = document.getElementById('alertMessage');
            
            alert.className = `alert ${type}`;
            alertMessage.textContent = message;
            alert.style.display = 'block';
        }

        function hideAlert() {
            const alert = document.getElementById('connectionAlert');
            alert.style.display = 'none';
        }

        function updateTimestamp() {
            const now = new Date();
            
            // Verificar si los elementos existen antes de actualizar
            if (document.getElementById('lastUpdate')) {
                document.getElementById('lastUpdate').textContent = now.toLocaleString('es-ES');
            }
            
            if (document.getElementById('updateTime')) {
                document.getElementById('updateTime').textContent = now.toLocaleTimeString('es-ES');
            }
            
            // Actualizar también la hora de verificación del sistema
            if (document.getElementById('systemCheckTime')) {
                document.getElementById('systemCheckTime').textContent = now.toLocaleTimeString('es-ES');
            }
            
            // Actualizar dashLastUpdate si existe
            if (document.getElementById('dashLastUpdate')) {
                document.getElementById('dashLastUpdate').textContent = now.toLocaleString('es-ES');
            }
        }

        function refreshData() {
            const refreshBtn = document.querySelector('.refresh-btn');
            refreshBtn.style.transform = 'rotate(360deg)';
            
            loadThingSpeakData();
            
            setTimeout(() => {
                refreshBtn.style.transform = 'rotate(0deg)';
            }, 500);
        }
    </script>
</body>
</html>